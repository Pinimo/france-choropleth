---
title: Articles
permalink: /
js: jquery, leaflet, d3
---

<div id="map"></div>

<script>

var map = L.map('map')
           .setView([46.6, 2.1], 6)
           .addLayer(new L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', {
              subdomains: 'abcd',
              detectRetina: true,
              minZoom: 6, maxZoom: 12 })),
    layers = {}, type ="";

function read(data, cl) {
  if (data.type === "Topology")
    for (key in data.objects) {
      geojson = topojson.feature(data, data.objects[key]); type = cl;
      new L.GeoJSON(geojson, {style: color, onEachFeature: store})
    }
}

function store(feature, json) {
  id = type;
  insee = feature.properties.insee;
  switch (type) {
    case "com": id += insee.substring(0,2); break;
    case "can": if (insee.length == 5) insee = "0"+insee;
                id += insee.substring(1,3);
  }
  var el = layers[id];
  if (el === undefined) {
    el = new L.layerGroup();
    layers[id] = el;
  }
  el.addLayer(json);
}

function color(feature) {
  return {
    fillColor: "#ccc",
    color: "#aaa",
    weight: 1,
    opacity: 1,
    fillOpacity: .8
  }
}

d3.json("data/geo/topo/cantons.json", function(json) {
  read(json, "can");
  d3.json("data/geo/topo/departements.json", function(json) {
    read(json, "dep");
    reset();
  });
});

function reset() {
  if(map.getZoom()<=8) {
    map.removeLayer(layers["dep"]);
    for (el in layers) {
      if (el.substring(0,3) == "com") map.removeLayer(layers[el]);
      if (el.substring(0,3) == "can") map.addLayer(layers[el]);
    }
  }
  if(map.getZoom()<=6)
    map.addLayer(layers["dep"]);
  if(map.getZoom()>8)
    for (dep in layers["dep"]["_layers"]) {
      dep = layers["dep"]["_layers"][dep];
      if (map.getBounds().contains(dep.getBounds()) ||
          map.getBounds().intersects(dep.getBounds())) {
        if (layers["com"+dep.feature.id] != undefined) {
          map.addLayer(layers["com"+dep.feature.id]);
          map.removeLayer(layers["can"+dep.feature.id]);
        }
        else
          (function(i){
            d3.json("data/geo/topo/"+i+".json", function(json) {
              read(json, "com");
              map.addLayer(layers["com"+i]);
              map.removeLayer(layers["can"+i]);
              });
          })(dep.feature.id);
      }
    }
}

map.on('move', reset);

</script>
