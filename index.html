<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Carto</title>
  <style>
  body{
    font-family: PT Sans, sans-serif;
    width: 700px;
    margin: 10px auto;
  }
  #map{
    height: 700px;
    background: #F5F5F3;
  }
  .leaflet-control-attribution{
    display: none;
  }
  .info {
    padding: 6px 8px;
    width: 180px;
    background: white;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
  }
  .info h4 {
      margin: 0 0 5px;
      color: #777;
  }
  </style>

  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
  <script>L_PREFER_CANVAS = true;</script>
  <script src="/js/leaflet.js"></script>
  <link href="/js/leaflet.css" rel="stylesheet"/>

</head>

<body>

  <h1>France-Leaflet</h1>

  <p>Leaflet map showing French <em>departements</em>, <em>cantons</em> and <em>communes</em> depanding of the zoom level.</p>

  <div id="map"></div>

  <script>

  var map = L.map('map')
             .setView([46.6, 2.1], 6)
             .addLayer(new L.tileLayer('https://cartodb-basemaps-b.global.ssl.fastly.net/light_nolabels/{z}/{x}/{y}.png', {
                subdomains: 'abcd',
                detectRetina: true,
                minZoom: 6, maxZoom: 12 }));

france(map);

function france(map) {

  $.getJSON("/data/geo/topojson/can.json", function(json) {
    read(json);
    $.getJSON("/data/geo/topojson/dep.json", function(json) {
      read(json);
      reset();
    });
  });

  info();
  map.on('zoomend', reset);
  map.on('dragend', reset);

  function read(data, cl) {
    if (window.layers === undefined)
      window.layers = {};
    if (data.type === "Topology")
      for (key in data.objects) {
        geojson = topojson.feature(data, data.objects[key]);
        new L.GeoJSON(geojson, {
          onEachFeature: function (feature, json) {
            switch (feature.properties.insee.length) {
              case 6: id = "can" + feature.properties.insee.substring(1,3); break;
              case 5: id = "com" + feature.properties.insee.substring(0,2); break;
              default: id = "dep";
            }
            var el = layers[id];
            if (el === undefined) {
              el = new L.layerGroup();
              layers[id] = el;
            }
            el.addLayer(json);
            json.on('mouseover', function () { info.update(feature.properties.nom) });
            json.on('mouseout', function () { info.update() });
          },
          style: {
            fillColor: "#ccc",
            color: "#aaa",
            weight: 1,
            opacity: 1,
            fillOpacity: .8
          }
        })
      }
  }

  function reset() {
    if(map.getZoom() <= 8)
      for (el in layers) {
        if (el.substring(0,3) == "com") map.removeLayer(layers[el]);
        if (el.substring(0,3) == "can") map.addLayer(layers[el]);
      }
    else
      for (dep in layers["dep"]["_layers"]) {
        d = layers["dep"]["_layers"][dep]; id=d.feature.id;
        if (map.getBounds().contains(d.getBounds()) ||
            map.getBounds().intersects(d.getBounds())) {
          if (layers["com"+id] != undefined)
            map.addLayer(layers["com"+id]).removeLayer(layers["can"+id]);
          else
            (function(id){ $.getJSON("/data/geo/topojson/com"+id+".json", function(json) {
              if (layers["can"+id].com != true){
                read(json);
                layers["can"+id].com = true;
              }
              if(map.getZoom()>8)
                map.addLayer(layers["com"+id]).removeLayer(layers["can"+id]);
            });})(id);        
         }
      }
    if(map.getZoom() <= 6)
      map.addLayer(layers["dep"]);
    else
      map.removeLayer(layers["dep"]);
  }

  function info(){
    window.info = L.control();
    info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info'); 
        this.update();
        return this._div;
    };
    info.update = function (props) {
      this._div.innerHTML = '<h4>Carte administrative</h4>' 
         + (props ? props : '<span style="color:#aaa">Survolez un territoire</span>')
    };
    info.addTo(map);
  }
}
  </script>
  
</body>
</html>
