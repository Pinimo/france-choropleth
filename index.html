<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Carto</title>
  <style>
  body{
    font-family: PT Sans, sans-serif;
    width: 700px;
    margin: 10px auto;
  }
  #map{
    height: 700px;
    background: #F5F5F3;
  }
  .leaflet-control-attribution{
    display: none;
  }
  </style>

  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script>L_PREFER_CANVAS = true;</script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
  <link href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" rel="stylesheet"/>
  <script src="/data/js/france.js"></script>

</head>

<body>

  <h1>France-Leaflet</h1>

  <p>Leaflet map showing French <em>departements</em>, <em>cantons</em> and <em>communes</em> depanding of the zoom level.</p>

  <div id="map"></div>

  <script>

  var map = L.map('map')
             .setView([46.6, 2.1], 6)
             .addLayer(new L.tileLayer('https://cartodb-basemaps-b.global.ssl.fastly.net/light_nolabels/{z}/{x}/{y}.png', {
                subdomains: 'abcd',
                detectRetina: true,
                minZoom: 6, maxZoom: 12 }));

  var layers = {};
  $.getJSON("/json/cantons.json", function(json) {
    read(json);
    $.getJSON("/json/departements.json", function(json) {
      read(json);
      reset();
    });
  });

  map.on('moveend', reset);

  function read(data, cl) {
    if (data.type === "Topology")
      for (key in data.objects) {
        geojson = topojson.feature(data, data.objects[key]);
        new L.GeoJSON(geojson, {style: color, onEachFeature: store})
      }
  }

  function store(feature, json) {
    switch (feature.properties.insee.length) {
      case 6: id = "can" + feature.properties.insee.substring(1,3); break;
      case 5: id = "com" + feature.properties.insee.substring(0,2); break;
      default: id = "dep";
    }

    var el = layers[id];
    if (el === undefined) {
      el = new L.layerGroup();
      layers[id] = el;
    }
    el.addLayer(json);
  }

  function color(feature) {
    return {
      fillColor: "#ccc",
      color: "#aaa",
      weight: 1,
      opacity: 1,
      fillOpacity: .8
    }
  }

  function communes(i){
    $.getJSON("/json/"+i+".json", function(json) {
      if (layers["can"+i].com != true){
        read(json);
        layers["can"+i].com = true;
      }
      if(map.getZoom()>8)
        map.addLayer(layers["com"+i]).removeLayer(layers["can"+i]);
      });
  }

  function reset() {
    if(map.getZoom()<=8) {
      map.removeLayer(layers["dep"]);
      for (el in layers) {
        if (el.substring(0,3) == "com") map.removeLayer(layers[el]);
        if (el.substring(0,3) == "can") map.addLayer(layers[el]);
      }
    }
    if(map.getZoom()<=6)
      map.addLayer(layers["dep"]);
    if(map.getZoom()>8)
      for (dep in layers["dep"]["_layers"]) {
        d = layers["dep"]["_layers"][dep]; id=d.feature.id;
        if (map.getBounds().contains(d.getBounds()) ||
            map.getBounds().intersects(d.getBounds())) {
          if (layers["com"+id] != undefined)
            map.addLayer(layers["com"+id]).removeLayer(layers["can"+id]);
          else
            communes(id);
        }
      }
  }
  
  </script>
  
</body>
</html>
